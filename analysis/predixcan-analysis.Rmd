---
title: "predixcan-analysis"
author: "natashasanthanam"
date: "2020-12-04"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## This is a script to calculate the correlation between two expression matrices generated by predixcan

```{sh, eval=FALSE}
hg19 <- read_tsv("/gpfs/data/im-lab/nas40t2/natasha/predixcan/psychencdoe_hg19__predict_new.txt")
amygdala <- read_tsv("/gpfs/data/im-lab/nas40t2/natasha/predixcan/amygdala__predict_new.txt")
identical(hg19$FID, amygdala$FID)
identical(hg19$IID, amygdala$IID)

gene_list <- intersect(names(hg19 %>% select( -c(FID, IID))), names(amygdala %>% select( -c(FID, IID))))

head(names(hg19 %>% select( -c(FID, IID)) ))
head(names(amygdala %>% select( -c(FID, IID)) ))

names(amygdala) <- substr(names(amygdala), 1, 15)
gene_list <- intersect(names(hg19 %>% select( -c(FID, IID))), names(amygdala %>% select( -c(FID, IID))))

cor_vec <- rep(NA, length(gene_list))
names(cor_vec) = gene_list
for(gg in gene_list) {
  res <- cor(hg19[[gg]], amygdala[[gg]])
  cor_vec[gg] <- res
}

summary(cor_vec)
write_rds(cor_vec, "/gpfs/data/im-lab/nas40t2/natasha/predixcan/test_cor_vec.RDS")
```

```{sh, eval=FALSE}
cor_vec <- readRDS("/Users/natashasanthanam/Users/natashasanthanamCRI/predixcan/test_cor_vec.RDS")

hist(cor_vec)
```


Generic function
```{sh, eval=FALSE}
fn_remove_ver_from_names = function(df)
{
  ind = substr(names(df),1,4) == "ENSG"
  names(df)[ind] = substr(names(df)[ind],1,15)
  df
}

fn_compare_expression_matrices = function(df1, df2, nplots = 4, common_genes=TRUE,plot_dir=NULL)
  {
  ## this function assumes that df1 and df2 have the first two columns named FID and IID"
  ## usage: 
  ## tempo_list = fn_compare_expression_matrices(df1, df2, plot_dir="working_dir/plots")
  ## to see plots on screen use the default value plot_dir=NULL by not specifying anything
  ## tempo_list = fn_compare_expression_matrices(df1, df2)
  print(dim(df1)) 
  print(dim(df2))
  if(!identical(df1$FID, df2$FID) |  !identical(df1$IID, df2$IID) )
  {
    id_tibble <- full_join(df1[,1:2], df2[,1:2])
    print(paste("in total there are ",nrow(id_tibble) , "rows") )
    df1 = left_join(id_tibble, df1, by=c("FID","IID"))  
    df2 = left_join(id_tibble, df2, by=c("FID","IID"))  
    print(identical(df1$FID, df2$FID))
    print(identical(df1$IID, df2$IID)) 
    print("the two lines above should say TRUE")
  } 
  ## remove version number from ensid
  df1 = fn_remove_ver_from_names(df1)
  df2 = fn_remove_ver_from_names(df2)
  if(common_genes)
  { 
    gene_list = intersect(names(df1),names(df2))
    gene_list = gene_list[!(gene_list %in% c("FID","IID"))] ## remove FID, IID
    print(glue::glue("There are {length(gene_list)} genes in common"))
    cor_vec = rep(NA, length(gene_list)); names(cor_vec) = gene_list
    for(gg in gene_list)
    {
      cor_vec[gg] = cor(df1[[gg]],df2[[gg]])
    }
    print(summary(cor_vec))
    for(pp in 1:nplots) {
      gg = sample(gene_list,1)
      if(!is.null(plot_dir)) png(glue::glue("{plot_dir}/{gg}_df1_vs_df2.png"))
      plot(df1[[gg]],df2[[gg]],main=paste(gg," - cor = ",round(cor_vec[gg]),2))
      if(!is.null(plot_dir)) dev.off()
    }
    if(!is.null(plot_dir)) png(glue::glue("{plot_dir}/hist_cor_df1_vs_df2.png"))
    hist(cor_vec,main="correlation between df1 and df2")
    if(!is.null(plot_dir)) dev.off()
  } else ## below is just testing, 10K by 10K is too large
  if(ncol(df1)*ncol(df2)<2e6){
    mat1 = scale( as.matrix(df1 %>% select(-c("FID","IID")) ) )
    mat2 = scale(as.matrix(df2 %>% select(-c("FID","IID")) ) )
    cor_mat = t(mat1) %*% mat2 / nrow(mat1)
  }
  list(df1,df2,cor_vec)
}
```

File to match length of expression data with that of phenotype file
```{sh, eval=FALSE}
Data = "/Users/natashasanthanam/Github/GTEX-Analysis/data"
phenotype_predixcan_complete <- read_tsv(glue::glue("{Data}/pheno_predixcan.txt"))

expression_data <- read_tsv("/Users/natashasanthanam/gardner/predixcan/predictions/psychencdoe_hg19__predict_new.txt")

new_expression <- inner_join(expression_data, phenotype_predixcan, by = c("FID", "IID"))
new_expression <- new_expression[, 1:length(expression_data)]

```

