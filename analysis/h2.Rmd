---
title: "h2"
author: "natashasanthanam"
date: "2020-10-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

Histogram and Summary Statistics for both Pvalues and H2 values generated by GCTA

Using this for loop, I generated the gcta output for all 256 phenotypes. I also ran the for loop again with the permuted phenotype file
```{sh eval=FALSE}
for i in {1..256}
do 
gcta --grm-bin /gpfs/data/im-lab/nas40t2/Data/GTEx/V8/genotype/plink_files/GTEX_grm_output --pheno /gpfs/data/im-lab/nas40t2/natasha/GTEX_Analysis/pheno_gtex_perm.txt --reml-no-constrain --out /gpfs/data/im-lab/nas40t2/natasha/GTEX_Analysis/perm_loop/gtex_output_perm_$i --thread-num 4 --mpheno $i
done
```


```{sh eval=FALSE}
library(workflowr)
library(tidyverse)
library(dplyr)
library(stringr)
library(plotly)
DATA="/Users/natashasanthanam/Github/GTEX-Analysis"
```


Pvalues and H2 values for GCTA output
```{sh eval=FALSE}
pval = read_tsv(glue::glue("{DATA}/pval.txt" ), col_names = FALSE)
hist(pval$X2)
summary(pval$X2)

h2 = read_tsv(glue::glue("{DATA}/vgvp.txt"),col_names=FALSE)
summary(h2$X2)
t.test(h2$X2)
wilcox.test(h2$X2, h2_perm$X2, alternative = "two.sided")
hist(h2$X2)
```

Pvalues and H2 values for GCTA output generated using permuted phenotype file
```{sh eval=FALSE}
pval_perm = read_tsv(glue::glue("{DATA}/pval_perm.txt" ), col_names = FALSE)
h2_perm = read_tsv(glue::glue("{DATA}/vgvp_perm.txt" ), col_names = FALSE)

hist(pval_perm$X2)
summary(pval_perm$X2)

summary(h2_perm$X2)
t.test(h2_perm$X2)
hist(h2_perm$X2)

```

```{sh eval=FALSE}
pval_perm2 = read_tsv(glue::glue("{DATA}/pval_perm2.txt" ), col_names = FALSE)
h2_perm2 = read_tsv(glue::glue("{DATA}/vgvp_perm2.txt" ), col_names = FALSE)

hist(pval_perm2$X2)
summary(pval_perm2$X2)

summary(h2_perm2$X2)
t.test(h2_perm2$X2)
hist(h2_perm2$X2)
```

```{sh eval=FALSE}
mytest = function(x) 
{ x= x[!is.na(x)]
  print(binom.test(sum(x >0) , n=length(x), p=0.5) ) 
}
```


Reading in Constrain h2 values 
```{sh eval=FALSE}
h2_constrain = read_tsv(glue::glue("{DATA}/vgvp_constrain.txt" ), col_names = FALSE)
h2_perm_constrain = read_tsv(glue::glue("{DATA}/vgvp_perm_constrain.txt" ), col_names = FALSE)
h2_perm_constrain2 = read_tsv(glue::glue("{DATA}/vgvp_perm_constrain2.txt" ), col_names = FALSE)
```


```{sh eval=FALSE}
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+")
} 
```


Original Data frame with all 3 h2 values for phenotypes
```{sh eval=FALSE}
h2_constrain$X1 = paste("Obs", numextract(h2_constrain$X1), sep = " ")
h2_perm_constrain$X1 = paste("Pm1", numextract(h2_perm_constrain$X1), sep = " ")

#takes 2 steps to separate the name of second perm
h2_perm_constrain2$X1 = numextract(substr(h2_perm_constrain2$X1, 46, 50))
h2_perm_constrain2$X1 = paste("Pm2",h2_perm_constrain2$X1 , sep = " ")

total = rbind(h2_constrain, h2_perm_constrain, h2_perm_constrain2)
total$X3 <- NULL
```


Tidying Total Data frame
```{sh eval=FALSE}
total2 <- total %>%
  separate(X1, c("Type", "Phenotype"), 3)

total2 <- data.frame(total2 %>%
  pivot_wider(names_from = Type, values_from = X2))

total2$Phenotype = str_sort(total2$Phenotype, numeric = TRUE)

colnames(total2) <- c("Phenotype", "Observed", "Perm1", "Perm2")

write_tsv(total2, "/Users/natashasanthanam/Github/GTEX-Analysis/df_total.txt", col_names=TRUE)
```


```{sh eval=FALSE}
fig <- plot_ly(x = total2$Observed, type="histogram", name="Observed")
fig <- fig %>% add_histogram(x = total2$Perm1, name="Permutation 1")
fig <- fig %>% add_histogram(x = total2$Perm2, name="Permutation 2")


fig
```


